{% extends "base.html" %}

{% block nav %}

    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo02">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                <ul class="navbar-nav m-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/welcome/index"><i class="fa-solid fa-house-user"></i> Strona główna</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/income/new"><i class="fa-solid fa-coins"></i> Dodaj przychód</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/expense/new"><i class="fa-solid fa-cart-shopping"></i> Dodaj wydatek</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/balance/index"><i class="fa-solid fa-scale-unbalanced"></i> Przeglądaj bilans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings/index"><i class="fa-solid fa-gear"></i> Ustawienia</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/login/destroy"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj się</a>
                    </li>
                    {% block nav_item %}
                    {% endblock %}
                </ul>
            </div>
            
        </nav>
    </div>

{% endblock %}

{% block footer %}

    <script src="/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript">
        $.fn.datepicker.dates['pl'] = {
            days: ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"],
            daysShort: ["Nd", "Pon", "Wt", "Śr", "Czw", "Pt", "Sob"],
            daysMin: ["Nd", "Pon", "Wt", "Śr", "Czw", "Pt", "Sob"],
            months: ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"],
            monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            today: "Dziś",
            clear: "Clear",
            format: "yyyy-mm-dd"
            //titleFormat: "MM yyyy",
            //weekStart: 0
        };

        $(".date").datepicker({
            startDate: '2000-01-01',
            endDate: new Date(),
            language: 'pl',
            autoclose: true
        });

        $(document).ready(function() {
            $('#formAddExpense, #addExpenseModal').validate({
                    errorPlacement: function(error, element) {
                    if (element.attr("name") == "amount") {
                        error.insertAfter(".amountErr");
                        error.css('color', 'red');
                    }
                    else if (element.attr("name") == "date") {
                        error.insertBefore(".dateErr");
                        error.css('color', 'red');
                    }
                    else if (element.attr("name") == "payment") {
                        error.insertBefore(".paymentErr");
                        error.css('color', 'red');
                    }
                    else if (element.attr("name") == "category") {
                        error.insertBefore(".categoryErr");
                        error.css('color', 'red');
                    }
                },
                rules: {
                    amount: {
                        required: true,
                        number: true,
                        min: 0.01,
                        max: 1000000.00
                    },
                    date: {
                        required: true
                    },
                    payment: {
                        required: true,
                        remote: '/validator/validate-payment-method'
                    },
                    category: {
                        required: true,
                        remote: '/validator/validate-expense-category'
                    }
                },
                messages: {
                    amount: {
                        number: 'Proszę wpisać kwotę do 2 miejsc po przecinku.',
                        min: 'Proszę wpisać kwotę większą lub równą 0.01.',
                        max: 'Kwota max. wynosi 1000000'
                    },
                    payment: {
                        remote: 'Proszę wpisać istniejącą metodę płatności'
                    },
                    category: {
                        remote: 'Proszę wpisać istniejącą kategorię wydatków'
                    },
                    date: {
                        date: 'Proszę wpisać poprawną datę.'
                    }
                }
            });

            $('#formAddIncome, #addIncomeModal').validate({
                errorPlacement: function(error, element) {
                    if (element.attr("name") == "amount") {
                        error.insertAfter(".amountErr");
                        error.css('color', 'red');
                    }
                    else if (element.attr("name") == "date") {
                        error.insertBefore(".dateErr");
                        error.css('color', 'red');
                    }
                    else if (element.attr("name") == "category") {
                        error.insertBefore(".categoryErr");
                        error.css('color', 'red');
                    }
                },
                rules: {
                    amount: {
                        required: true,
                        number: true,
                        min: 0.01,
                        max: 1000000.00
                    },
                    date: {
                        required: true
                    },
                    category: {
                        required: true,
                        remote: '/validator/validate-income-category'
                    }
                },
                messages: {
                    amount: {
                        number: 'Proszę wpisać kwotę do 2 miejsc po przecinku.',
                        min: 'Proszę wpisać kwotę większą lub równą 0.01.',
                        max: 'Kwota max. wynosi 1000000'
                    },
                    category: {
                        remote: 'Proszę wpisać istniejącą kategorię wydatków'
                    },
                    date: {
                        date: 'Proszę wpisać poprawną datę.'
                    }
                }
            });

            $('#period').change(function() {
                var opval = $(this).val(); 
                if (opval == "custom") { 
                    $('#customPeriodModal').modal("show");
                }
            });

            $('#customPeriodForm').validate({
                errorPlacement: function(error, element) {
                    if (element.attr("name") == "start-date") {
                        error.insertAfter(".startDateErr");
                        error.css('color', 'red');
                    }
                    else if (element.attr("name") == "end-date") {
                        error.insertBefore(".endDateErr");
                        error.css('color', 'red');
                    }
                },
                rules: {
                    'start-date': {
                        required: true
                    },
                    'end-date': {
                        required: true,
                        greaterThan: '#start-date'
                    }
                },
                messages: {
                    'start-date': {
                        date: 'Proszę wpisać poprawną datę.'
                    },
                    'end-date': {
                        date: 'Proszę wpisać poprawną datę.',
                    }
                }
            });

        });

        $.validator.methods.number = function(value, element, param) {
            return this.optional(element) || /^-?(?:\d+|\d+(?:\.\d{2})+)?(?:,\d+)?$/.test(value);
        }

        jQuery.validator.addMethod("greaterThan", 
            function(value, element, params) {
                return value >= $(params).val();
            },
        'Data końcowa musi być większa od początkowej.');

        //pie chart for expenses

        var expenses = $('#for-pie-chart').data('expenses');

        function expenseLabels() {
            const labels = [];

            for (let i = 0; i < expenses.length; i++) {
                labels.push(expenses[i].name);
            }

            return labels;
        }

        function expenseAmounts() {
            const amounts = [];

            for (let i = 0; i < expenses.length; i++) {
                amounts.push(expenses[i].amount);
            }

            return amounts;
        }

        const ctx = document.getElementById('expensesChart');
  
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: expenseLabels(),
                datasets: [{
                    data: expenseAmounts(),
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)',
                        'rgb(0,128,0)',
                        'rgb(210,105,30)',
                        'rgb(139,0,139)',
                        'rgb(65,105,225)',
                        'rgb(255,127,80)',
                        'rgb(0,128,128)',
                        'rgb(255,0,255)'
                    ],
                    hoverOffset: 4
                }]
            },
        });

        $('#editExpenseModal').on('hidden.bs.modal', function(e){
           $(this).find('#addExpenseModal')[0].reset();           
        });

        $('#editIncomeModal').on('hidden.bs.modal', function(e){
           $(this).find('#addIncomeModal')[0].reset();           
        });

        // income data in edit income modal
        $(document).on('click', '#edit-income', function() {
            var income = $(this).data('income');
            $('.modal-body #incomeId').val(income.id);
            $('.modal-body #inputIncome').val(income.amount);
            $('.modal-body #date').val(income.date_of_income);
            $('.modal-body #selectIncomeCategory #incomeCategory').val(income.name).text(income.name);
            $("#selectIncomeCategory option").each(function() {
                $(this).siblings('[value="'+ this.value +'"]').remove();
            });
            $('.modal-body #comment').val(income.income_comment);
        });

        // income id for delete income modal
        $(document).on('click', '#delete-income', function() {
            var id = $(this).data('id');
            $('.modal-body #incomeId').val(id);
        });

        // expense id for delete expense modal
        $(document).on('click', '#delete-expense', function() {
            var id = $(this).data('id');
            $('.modal-body #expenseId').val(id);
        });

        // expense data in edit expense modal
        $(document).on('click', '#edit-expense', function() {
            var expense = $(this).data('expense');
            $('.modal-body #expenseId').val(expense.id);
            $('.modal-body #inputExpense').val(expense.amount);
            $('.modal-body #date').val(expense.date_of_expense);
            $('.modal-body #selectPaymentMethod #paymentMethod').val(expense.payment).text(expense.payment);
            $('.modal-body #selectExpenseCategory #expenseCategory').val(expense.name).text(expense.name);
            $("#selectPaymentMethod option, #selectExpenseCategory option").each(function() {
                $(this).siblings('[value="'+ this.value +'"]').remove();
            });
            $('.modal-body #comment').val(expense.expense_comment);
        });

    </script>

{% endblock %}